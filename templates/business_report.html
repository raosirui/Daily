<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>商机上报 - 日报管理系统</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container-fluid">
        <div class="header">
            <h1>日报管理系统</h1>
            <div class="user-info">
                <span class="user-name">欢迎，{{ username }}</span>
                <a href="/logout" class="btn btn-secondary">退出登录</a>
            </div>
        </div>
        
        <!-- 功能标签切换 -->
        <div class="nav-tabs">
            <a href="/daily_report" class="nav-tab">日报</a>
            <a href="/business_report" class="nav-tab active">商机上报</a>
        </div>
        
        {% if success %}
        <div class="alert alert-success">
            {{ success }}
        </div>
        {% endif %}
        {% if error %}
        <div class="alert alert-danger">
            {{ error }}
        </div>
        {% endif %}
        
        <!-- 商机上报表单 -->
        <div class="card mb-4">
            <div class="card-header">
                <h2>商机上报</h2>
            </div>
            <div class="card-body">
                <form action="/submit_business" method="POST">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="project_name" class="form-label">项目名称 *</label>
                                <div class="project-input-group">
                                    <input type="text" class="form-control project-combobox" id="project_name" name="project_name" required placeholder="输入项目名称..." list="project_list" autocomplete="off">
                                    <datalist id="project_list">
                                        <option value=""></option>
                                    </datalist>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="construction_unit" class="form-label">建设单位 *</label>
                                <input type="text" class="form-control" id="construction_unit" name="construction_unit" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="source" class="form-label">项目信息来源 *</label>
                                <input type="text" class="form-control" id="source" name="source" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="estimated_amount" class="form-label">预估金额（万元）</label>
                                <input type="number" class="form-control" id="estimated_amount" name="estimated_amount" step="0.01" min="0">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="responsible_person" class="form-label">市场责任人 *</label>
                                <select class="form-control" id="responsible_person" name="responsible_person" required>
                                    {% for user in all_users %}
                                    <option value="{{ user }}" {% if user == username %}selected{% endif %}>{{ user }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="project_type" class="form-label">项目性质 *</label>
                                <select class="form-control" id="project_type" name="project_type" required>
                                    <option value="">请选择项目性质</option>
                                    {% for type in project_types %}
                                    <option value="{{ type }}">{{ type }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="status" class="form-label">状态 *</label>
                                <select class="form-control" id="status" name="status" required>
                                    <option value="">请选择状态</option>
                                    {% for status in opportunity_status %}
                                    <option value="{{ status }}">{{ status }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="tracking_info" class="form-label">跟踪情况更新</label>
                                <textarea class="form-control" id="tracking_info" name="tracking_info" rows="3"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="remarks" class="form-label">备注</label>
                                <textarea class="form-control" id="remarks" name="remarks" rows="2"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="button-container">
                        <button type="submit" class="btn btn-success">提交商机</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- 商机列表 -->
        <div class="card">
            <div class="card-header">
                <h2>已上报商机列表</h2>
                <a href="/download_business_opportunities" class="btn btn-primary download-btn">下载商机数据(TXT)</a>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>项目名称</th>
                                <th>建设单位</th>
                                <th>信息来源</th>
                                <th>预估金额</th>
                                <th>责任人</th>
                                <th>项目性质</th>
                                <th>状态</th>
                                <th>跟踪情况</th>
                                <th>备注</th>
                                <th>上报人</th>
                                <th>上报时间</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for opportunity in opportunities %}
                            <tr>
                                <td>{{ opportunity.project_name }}</td>
                                <td>{{ opportunity.construction_unit }}</td>
                                <td>{{ opportunity.source }}</td>
                                <td>{{ opportunity.estimated_amount if opportunity.estimated_amount else '-' }}</td>
                                <td>{{ opportunity.responsible_person }}</td>
                                <td>{{ opportunity.project_type }}</td>
                                <td>{{ opportunity.status }}</td>
                                <td>{{ opportunity.tracking_info if opportunity.tracking_info else '-' }}</td>
                                <td>{{ opportunity.remarks if opportunity.remarks else '-' }}</td>
                                <td>{{ opportunity.reporter }}</td>
                                <td>{{ opportunity.report_time }}</td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="11" class="text-center">暂无商机记录</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    <script>
        // 项目名称搜索功能
        const projectInput = document.getElementById('project_name');
        const datalist = document.getElementById('project_list');
        
        projectInput.addEventListener('input', function() {
            const keyword = this.value.trim();
            if (keyword) {
                fetch(`/search_projects?keyword=${encodeURIComponent(keyword)}`) 
                    .then(response => response.json())
                    .then(data => {
                        // 清空现有选项
                        datalist.innerHTML = '';
                        
                        // 添加新选项
                        data.forEach(project => {
                            const option = document.createElement('option');
                            option.value = project;
                            datalist.appendChild(option);
                        });
                    })
                    .catch(error => console.error('搜索项目失败:', error));
            }
        });
        
        // 禁止选择下拉框中的内容
        projectInput.addEventListener('change', function() {
            const selectedValue = this.value;
            const options = Array.from(datalist.options).map(opt => opt.value);
            
            // 检查是否选择了下拉框中的值
            if (options.includes(selectedValue)) {
                alert('不能选择已存在的项目，请输入新项目名称！');
                this.value = '';
            }
        });
        
        // 表单提交前验证
        document.querySelector('form[action="/submit_business"]').addEventListener('submit', function(event) {
            const projectName = projectInput.value.trim();
            
            // 异步验证项目名称是否存在
            fetch(`/check_project_exists?project_name=${encodeURIComponent(projectName)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.exists) {
                        alert('该项目名称已存在，请输入新项目名称！');
                        event.preventDefault();
                    } else {
                        // 验证通过，提交表单
                        this.submit();
                    }
                })
                .catch(error => {
                    console.error('验证项目名称失败:', error);
                    event.preventDefault();
                });
                
            // 阻止表单默认提交，等待异步验证结果
            event.preventDefault();
        });
    </script>
</body>
</html>